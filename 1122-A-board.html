<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸©é¦¨ç•™è¨€æ¿ - 1122å®¢å…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fish: {
                            50: '#F0F7FF',
                            100: '#E0F0FF',
                            300: '#99CCF3',
                            400: '#66B3E8',
                        },
                        rabbit: {
                            50: '#FFF5F9',
                            100: '#FFEFF6',
                            300: '#FFC2D1',
                            400: '#FFB0C4',
                        }
                    },
                    fontFamily: {
                        cute: ['"Comic Sans MS"', '"Arial Rounded MT Bold"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style type="text/css">
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2399ccf3' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .message-card {
            transition: all 0.3s ease;
        }
        .message-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-fish-50 via-white to-rabbit-50 bg-pattern min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨è£…é¥°æ¡ -->
    <div class="w-full h-1.5 bg-gradient-to-r from-fish-400 via-rabbit-300 to-fish-300"></div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">
        <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
        <div id="userBar" class="mb-6 flex justify-end">
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div id="notLoggedIn" class="flex gap-2">
                <button id="loginBtn" class="bg-white hover:bg-fish-50 text-gray-800 font-medium py-2 px-4 rounded-full transition-all duration-300 shadow-sm border border-fish-100 hover:shadow-md text-sm">
                    <i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•
                </button>
                <button id="registerBtn" class="bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-2 px-4 rounded-full transition-all duration-300 shadow-sm hover:shadow-md text-sm">
                    <i class="fas fa-user-plus mr-1"></i>æ³¨å†Œ
                </button>
            </div>
            
            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="loggedIn" class="hidden flex items-center gap-3">
                <div class="flex items-center gap-2 bg-white rounded-full py-2 px-4 shadow-sm border border-fish-100">
                    <div id="userAvatarDisplay" class="w-8 h-8 rounded-full bg-gradient-to-br from-fish-300 to-fish-400 flex items-center justify-center">
                        <i class="fas fa-fish text-white"></i>
                    </div>
                    <span id="userNicknameDisplay" class="text-gray-800 font-medium text-sm"></span>
                </div>
                <button id="userMenuBtn" class="bg-white hover:bg-fish-50 text-gray-800 font-medium py-2 px-3 rounded-full transition-all duration-300 shadow-sm border border-fish-100 hover:shadow-md">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="logoutBtn" class="bg-white hover:bg-red-50 text-red-500 font-medium py-2 px-3 rounded-full transition-all duration-300 shadow-sm border border-red-100 hover:shadow-md">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- æ ‡é¢˜åŒº -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-fish-100 to-rabbit-100 mb-3 shadow-md">
                <i class="fas fa-message text-4xl text-fish-400"></i>
            </div>
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-cute font-bold bg-gradient-to-r from-fish-400 to-rabbit-400 bg-clip-text text-transparent mb-2">
                æ¸©é¦¨ç•™è¨€æ¿
            </h1>
            <p class="text-gray-600 text-sm">åœ¨è¿™é‡Œç•™ä¸‹ä½ çš„å¿ƒæƒ…å’Œç¥ç¦ ğŸ’Œ</p>
        </div>

        <!-- å‘è¡¨ç•™è¨€æŒ‰é’® -->
        <div class="mb-8 text-center">
            <button id="postMessageBtn" class="inline-flex items-center gap-2 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-8 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                <i class="fas fa-pen"></i>
                <span>å‘è¡¨ç•™è¨€</span>
            </button>
        </div>

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div id="messageList" class="space-y-4 mb-8">
            <!-- ç•™è¨€å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="text-center py-16 hidden">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-400 text-lg">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div class="text-center mt-8">
            <a href="1122-A.html" class="inline-flex items-center gap-2 bg-white hover:bg-fish-50 text-gray-800 font-medium py-3 px-6 rounded-full transition-all duration-300 shadow-sm border border-fish-100 hover:shadow-md">
                <i class="fas fa-arrow-left"></i>
                <span>è¿”å›å®¢å…</span>
            </a>
        </div>
    </main>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full">
            <div class="sticky top-0 bg-gradient-to-r from-fish-400 to-rabbit-400 text-white p-6 rounded-t-3xl">
                <h2 class="text-2xl font-cute font-bold text-center">ç™»å½•</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" maxlength="50" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all">
                </div>

                <div class="flex gap-3">
                    <button id="loginCancelBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-300">
                        å–æ¶ˆ
                    </button>
                    <button id="loginSubmitBtn" class="flex-1 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                        ç™»å½•
                    </button>
                </div>

                <div class="mt-4 text-center">
                    <span class="text-sm text-gray-600">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                    <button id="switchToRegister" class="text-sm text-fish-400 hover:text-fish-500 font-medium">
                        ç«‹å³æ³¨å†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œå¼¹çª— -->
    <div id="registerModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-fish-400 to-rabbit-400 text-white p-6 rounded-t-3xl">
                <h2 class="text-2xl font-cute font-bold text-center">æ³¨å†Œ</h2>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" maxlength="50" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯†ç </label>
                    <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç " class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ˜µç§°</label>
                    <input type="text" id="registerNickname" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="50" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all">
                </div>

                <!-- å¤´åƒé€‰æ‹© -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å¤´åƒ</label>
                    <div class="flex gap-3 flex-wrap justify-center">
                        <div class="avatar-option-register w-16 h-16 rounded-full bg-gradient-to-br from-fish-300 to-fish-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-fish-400 transition-all" data-avatar="fish">
                            <i class="fas fa-fish text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-register w-16 h-16 rounded-full bg-gradient-to-br from-rabbit-300 to-rabbit-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-rabbit-400 transition-all" data-avatar="rabbit">
                            <i class="fas fa-heart text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-register w-16 h-16 rounded-full bg-gradient-to-br from-purple-300 to-purple-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-purple-400 transition-all" data-avatar="star">
                            <i class="fas fa-star text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-register w-16 h-16 rounded-full bg-gradient-to-br from-green-300 to-green-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-green-400 transition-all" data-avatar="leaf">
                            <i class="fas fa-leaf text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-register w-16 h-16 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-yellow-400 transition-all" data-avatar="sun">
                            <i class="fas fa-sun text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-register w-16 h-16 rounded-full bg-gradient-to-br from-pink-300 to-pink-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-pink-400 transition-all" data-avatar="cloud">
                            <i class="fas fa-cloud text-white text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æˆ–ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ</label>
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0">
                            <div id="registerAvatarPreview" class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                <i class="fas fa-image text-gray-400 text-2xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <input type="file" id="registerAvatarUpload" accept="image/*" class="hidden">
                            <button type="button" onclick="document.getElementById('registerAvatarUpload').click()" class="bg-fish-100 hover:bg-fish-200 text-fish-600 font-medium py-2 px-4 rounded-lg transition-all duration-300 text-sm">
                                <i class="fas fa-upload mr-1"></i>é€‰æ‹©å›¾ç‰‡
                            </button>
                            <p class="text-xs text-gray-500 mt-1">æ”¯æŒ JPGã€PNGã€GIFï¼Œæœ€å¤§ 5MB</p>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="registerCancelBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-300">
                        å–æ¶ˆ
                    </button>
                    <button id="registerSubmitBtn" class="flex-1 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                        æ³¨å†Œ
                    </button>
                </div>

                <div class="mt-4 text-center">
                    <span class="text-sm text-gray-600">å·²æœ‰è´¦å·ï¼Ÿ</span>
                    <button id="switchToLogin" class="text-sm text-fish-400 hover:text-fish-500 font-medium">
                        ç«‹å³ç™»å½•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·è®¾ç½®å¼¹çª— -->
    <div id="userSettingsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full">
            <div class="sticky top-0 bg-gradient-to-r from-fish-400 to-rabbit-400 text-white p-6 rounded-t-3xl">
                <h2 class="text-2xl font-cute font-bold text-center">ä¸ªäººè®¾ç½®</h2>
            </div>
            
            <div class="p-6">
                <!-- å¤´åƒé€‰æ‹© -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©é¢„è®¾å¤´åƒ</label>
                    <div class="flex gap-3 flex-wrap justify-center">
                        <div class="avatar-option-settings w-16 h-16 rounded-full bg-gradient-to-br from-fish-300 to-fish-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-fish-400 transition-all" data-avatar="fish">
                            <i class="fas fa-fish text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-settings w-16 h-16 rounded-full bg-gradient-to-br from-rabbit-300 to-rabbit-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-rabbit-400 transition-all" data-avatar="rabbit">
                            <i class="fas fa-heart text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-settings w-16 h-16 rounded-full bg-gradient-to-br from-purple-300 to-purple-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-purple-400 transition-all" data-avatar="star">
                            <i class="fas fa-star text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-settings w-16 h-16 rounded-full bg-gradient-to-br from-green-300 to-green-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-green-400 transition-all" data-avatar="leaf">
                            <i class="fas fa-leaf text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-settings w-16 h-16 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-yellow-400 transition-all" data-avatar="sun">
                            <i class="fas fa-sun text-white text-2xl"></i>
                        </div>
                        <div class="avatar-option-settings w-16 h-16 rounded-full bg-gradient-to-br from-pink-300 to-pink-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-pink-400 transition-all" data-avatar="cloud">
                            <i class="fas fa-cloud text-white text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">æˆ–ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒ</label>
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0">
                            <div id="settingsAvatarPreview" class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                <i class="fas fa-image text-gray-400 text-2xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <input type="file" id="settingsAvatarUpload" accept="image/*" class="hidden">
                            <button type="button" onclick="document.getElementById('settingsAvatarUpload').click()" class="bg-fish-100 hover:bg-fish-200 text-fish-600 font-medium py-2 px-4 rounded-lg transition-all duration-300 text-sm">
                                <i class="fas fa-upload mr-1"></i>é€‰æ‹©å›¾ç‰‡
                            </button>
                            <p class="text-xs text-gray-500 mt-1">æ”¯æŒ JPGã€PNGã€GIFï¼Œæœ€å¤§ 5MB</p>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="settingsCancelBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-300">
                        å–æ¶ˆ
                    </button>
                    <button id="settingsSaveBtn" class="flex-1 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å‘è¡¨ç•™è¨€å¼¹çª— -->
    <div id="postModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-fish-400 to-rabbit-400 text-white p-6 rounded-t-3xl">
                <h2 class="text-2xl font-cute font-bold text-center">å‘è¡¨ç•™è¨€</h2>
            </div>
            
            <div class="p-6">
                <!-- ç•™è¨€å†…å®¹ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç•™è¨€å†…å®¹</label>
                    <textarea id="messageContent" rows="5" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..." maxlength="500" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all resize-none"></textarea>
                    <div class="text-right text-sm text-gray-400 mt-1">
                        <span id="charCount">0</span>/500
                    </div>
                </div>

                <!-- æŒ‰é’®ç»„ -->
                <div class="flex gap-3">
                    <button id="cancelBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-300">
                        å–æ¶ˆ
                    </button>
                    <button id="submitBtn" class="flex-1 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                        å‘è¡¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="py-4 text-center text-gray-500 text-sm">
        <p>ğŸ’• æ¯ä¸€æ¡ç•™è¨€éƒ½æ˜¯çè´µçš„å›å¿† ğŸ’•</p>
    </footer>

    <script>
        // APIé…ç½® - ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€
        const API_BASE_URL = 'https://fish-rabbit.site/api';
        
        // æ•°æ®å­˜å‚¨é”®ï¼ˆåªç”¨äºå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼‰
        const STORAGE_KEYS = {
            USER: 'messageBoard_user'
        };

        // å¤´åƒé…ç½®
        const AVATAR_CONFIG = {
            fish: { icon: 'fa-fish', gradient: 'from-fish-300 to-fish-400' },
            rabbit: { icon: 'fa-heart', gradient: 'from-rabbit-300 to-rabbit-400' },
            star: { icon: 'fa-star', gradient: 'from-purple-300 to-purple-400' },
            leaf: { icon: 'fa-leaf', gradient: 'from-green-300 to-green-400' },
            sun: { icon: 'fa-sun', gradient: 'from-yellow-300 to-yellow-400' },
            cloud: { icon: 'fa-cloud', gradient: 'from-pink-300 to-pink-400' }
        };

        // å½“å‰é€‰æ‹©çš„å¤´åƒ
        let selectedAvatar = 'fish';
        let selectedAvatarRegister = 'fish';
        let selectedAvatarSettings = 'fish';
        
        // ä¸Šä¼ çš„å¤´åƒURL
        let uploadedAvatarRegister = null;
        let uploadedAvatarSettings = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();
            initEventListeners();
            updateUserUI();
        });

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserUI() {
            const user = getUserInfo();
            const notLoggedIn = document.getElementById('notLoggedIn');
            const loggedIn = document.getElementById('loggedIn');
            
            if (user) {
                notLoggedIn.classList.add('hidden');
                loggedIn.classList.remove('hidden');
                
                // æ›´æ–°æ˜¾ç¤ºçš„ç”¨æˆ·ä¿¡æ¯
                document.getElementById('userNicknameDisplay').textContent = user.nickname;
                
                // æ›´æ–°å¤´åƒ
                const avatarDisplay = document.getElementById('userAvatarDisplay');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰ä¸Šä¼ çš„å¤´åƒ
                if (user.avatar.startsWith('/uploads/') || user.avatar.startsWith('http')) {
                    // è‡ªå®šä¹‰ä¸Šä¼ çš„å¤´åƒ
                    const avatarUrl = user.avatar.startsWith('http') ? user.avatar : `${API_BASE_URL.replace('/api', '')}${user.avatar}`;
                    avatarDisplay.className = `w-8 h-8 rounded-full overflow-hidden border-2 border-fish-100`;
                    avatarDisplay.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover">`;
                } else {
                    // é¢„è®¾å¤´åƒ
                    const avatarConfig = AVATAR_CONFIG[user.avatar] || AVATAR_CONFIG.fish;
                    avatarDisplay.className = `w-8 h-8 rounded-full bg-gradient-to-br ${avatarConfig.gradient} flex items-center justify-center`;
                    avatarDisplay.innerHTML = `<i class="fas ${avatarConfig.icon} text-white"></i>`;
                }
            } else {
                notLoggedIn.classList.remove('hidden');
                loggedIn.classList.add('hidden');
            }
        }
        
        // æ¸²æŸ“å¤´åƒHTMLï¼ˆç”¨äºç•™è¨€åˆ—è¡¨ï¼‰
        function renderAvatar(avatar) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰ä¸Šä¼ çš„å¤´åƒ
            if (avatar.startsWith('/uploads/') || avatar.startsWith('http')) {
                // è‡ªå®šä¹‰ä¸Šä¼ çš„å¤´åƒ
                const avatarUrl = avatar.startsWith('http') ? avatar : `${API_BASE_URL.replace('/api', '')}${avatar}`;
                return `
                    <div class="flex-shrink-0 w-12 h-12 rounded-full overflow-hidden shadow-md border-2 border-white">
                        <img src="${avatarUrl}" class="w-full h-full object-cover">
                    </div>
                `;
            } else {
                // é¢„è®¾å¤´åƒ
                const avatarConfig = AVATAR_CONFIG[avatar] || AVATAR_CONFIG.fish;
                return `
                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-gradient-to-br ${avatarConfig.gradient} flex items-center justify-center shadow-md">
                        <i class="fas ${avatarConfig.icon} text-white text-xl"></i>
                    </div>
                `;
            }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            const userStr = localStorage.getItem(STORAGE_KEYS.USER);
            return userStr ? JSON.parse(userStr) : null;
        }

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveUserToLocal(user) {
            localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(user));
        }

        // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
        function clearUserInfo() {
            localStorage.removeItem(STORAGE_KEYS.USER);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // é¡¶éƒ¨æŒ‰é’®
            document.getElementById('loginBtn').addEventListener('click', openLoginModal);
            document.getElementById('registerBtn').addEventListener('click', openRegisterModal);
            document.getElementById('userMenuBtn').addEventListener('click', openUserSettingsModal);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // ç™»å½•å¼¹çª—
            document.getElementById('loginCancelBtn').addEventListener('click', closeLoginModal);
            document.getElementById('loginSubmitBtn').addEventListener('click', submitLogin);
            document.getElementById('switchToRegister').addEventListener('click', () => {
                closeLoginModal();
                openRegisterModal();
            });
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) closeLoginModal();
            });
            
            // æ³¨å†Œå¼¹çª—
            document.getElementById('registerCancelBtn').addEventListener('click', closeRegisterModal);
            document.getElementById('registerSubmitBtn').addEventListener('click', submitRegister);
            document.getElementById('switchToLogin').addEventListener('click', () => {
                closeRegisterModal();
                openLoginModal();
            });
            document.getElementById('registerModal').addEventListener('click', function(e) {
                if (e.target === this) closeRegisterModal();
            });
            
            // æ³¨å†Œå¤´åƒé€‰æ‹©
            document.querySelectorAll('.avatar-option-register').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.avatar-option-register').forEach(opt => {
                        opt.classList.remove('ring-4', 'ring-fish-400', 'ring-rabbit-400', 'ring-purple-400', 'ring-green-400', 'ring-yellow-400', 'ring-pink-400');
                    });
                    this.classList.add('ring-4');
                    const avatar = this.dataset.avatar;
                    selectedAvatarRegister = avatar;
                    uploadedAvatarRegister = null; // æ¸…é™¤ä¸Šä¼ çš„å¤´åƒ
                    const ringColor = {
                        fish: 'ring-fish-400', rabbit: 'ring-rabbit-400', star: 'ring-purple-400',
                        leaf: 'ring-green-400', sun: 'ring-yellow-400', cloud: 'ring-pink-400'
                    }[avatar];
                    this.classList.add(ringColor);
                });
            });
            
            // æ³¨å†Œä¸Šä¼ å¤´åƒ
            document.getElementById('registerAvatarUpload').addEventListener('change', handleRegisterAvatarUpload);
            
            // ç”¨æˆ·è®¾ç½®å¼¹çª—
            document.getElementById('settingsCancelBtn').addEventListener('click', closeUserSettingsModal);
            document.getElementById('settingsSaveBtn').addEventListener('click', saveUserSettings);
            document.getElementById('userSettingsModal').addEventListener('click', function(e) {
                if (e.target === this) closeUserSettingsModal();
            });
            
            // è®¾ç½®å¤´åƒé€‰æ‹©
            document.querySelectorAll('.avatar-option-settings').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.avatar-option-settings').forEach(opt => {
                        opt.classList.remove('ring-4', 'ring-fish-400', 'ring-rabbit-400', 'ring-purple-400', 'ring-green-400', 'ring-yellow-400', 'ring-pink-400');
                    });
                    this.classList.add('ring-4');
                    const avatar = this.dataset.avatar;
                    selectedAvatarSettings = avatar;
                    uploadedAvatarSettings = null; // æ¸…é™¤ä¸Šä¼ çš„å¤´åƒ
                    const ringColor = {
                        fish: 'ring-fish-400', rabbit: 'ring-rabbit-400', star: 'ring-purple-400',
                        leaf: 'ring-green-400', sun: 'ring-yellow-400', cloud: 'ring-pink-400'
                    }[avatar];
                    this.classList.add(ringColor);
                });
            });
            
            // è®¾ç½®ä¸Šä¼ å¤´åƒ
            document.getElementById('settingsAvatarUpload').addEventListener('change', handleSettingsAvatarUpload);

            // å‘è¡¨ç•™è¨€æŒ‰é’®
            document.getElementById('postMessageBtn').addEventListener('click', openPostModal);

            // å…³é—­å‘è¡¨ç•™è¨€å¼¹çª—
            document.getElementById('cancelBtn').addEventListener('click', closePostModal);

            // æäº¤ç•™è¨€
            document.getElementById('submitBtn').addEventListener('click', submitMessage);

            // å­—æ•°ç»Ÿè®¡
            document.getElementById('messageContent').addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
            document.getElementById('postModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePostModal();
                }
            });
        }

        // ========== å¤´åƒä¸Šä¼ ç›¸å…³ ==========
        // å¤„ç†æ³¨å†Œæ—¶ä¸Šä¼ å¤´åƒ
        async function handleRegisterAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                return;
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('registerAvatarPreview');
                preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ åˆ°æœåŠ¡å™¨
            try {
                const formData = new FormData();
                formData.append('avatar', file);

                const response = await fetch(`${API_BASE_URL}/upload/avatar`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
                }

                uploadedAvatarRegister = data.avatarUrl;
                
                // æ¸…é™¤é¢„è®¾å¤´åƒé€‰æ‹©
                document.querySelectorAll('.avatar-option-register').forEach(opt => {
                    opt.classList.remove('ring-4', 'ring-fish-400', 'ring-rabbit-400', 'ring-purple-400', 'ring-green-400', 'ring-yellow-400', 'ring-pink-400');
                });
                
                showToast('å¤´åƒä¸Šä¼ æˆåŠŸ', 'success');
            } catch (error) {
                console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', error);
                showToast(error.message || 'ä¸Šä¼ å¤´åƒå¤±è´¥', 'error');
            }
        }

        // å¤„ç†è®¾ç½®æ—¶ä¸Šä¼ å¤´åƒ
        async function handleSettingsAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                return;
            }

            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('settingsAvatarPreview');
                preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ åˆ°æœåŠ¡å™¨
            try {
                const formData = new FormData();
                formData.append('avatar', file);

                const response = await fetch(`${API_BASE_URL}/upload/avatar`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
                }

                uploadedAvatarSettings = data.avatarUrl;
                
                // æ¸…é™¤é¢„è®¾å¤´åƒé€‰æ‹©
                document.querySelectorAll('.avatar-option-settings').forEach(opt => {
                    opt.classList.remove('ring-4', 'ring-fish-400', 'ring-rabbit-400', 'ring-purple-400', 'ring-green-400', 'ring-yellow-400', 'ring-pink-400');
                });
                
                showToast('å¤´åƒä¸Šä¼ æˆåŠŸ', 'success');
            } catch (error) {
                console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', error);
                showToast(error.message || 'ä¸Šä¼ å¤´åƒå¤±è´¥', 'error');
            }
        }

        // ========== ç™»å½•ç›¸å…³ ==========
        function openLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        async function submitLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ç™»å½•å¤±è´¥');
                }

                // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°
                saveUserToLocal(data.user);
                updateUserUI();
                closeLoginModal();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
                
                // åˆ·æ–°ç•™è¨€åˆ—è¡¨
                await loadMessages();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showToast(error.message || 'ç™»å½•å¤±è´¥', 'error');
            }
        }

        // ========== æ³¨å†Œç›¸å…³ ==========
        function openRegisterModal() {
            document.getElementById('registerModal').classList.remove('hidden');
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerNickname').value = '';
            // é‡ç½®ä¸Šä¼ å¤´åƒ
            uploadedAvatarRegister = null;
            document.getElementById('registerAvatarPreview').innerHTML = '<i class="fas fa-image text-gray-400 text-2xl"></i>';
            document.getElementById('registerAvatarUpload').value = '';
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¤´åƒ
            selectedAvatarRegister = 'fish';
            document.querySelector('.avatar-option-register[data-avatar="fish"]').click();
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.add('hidden');
        }

        async function submitRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const nickname = document.getElementById('registerNickname').value.trim();

            if (!username || !password || !nickname) {
                showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            // ç¡®å®šä½¿ç”¨å“ªä¸ªå¤´åƒï¼ˆä¸Šä¼ çš„ä¼˜å…ˆï¼‰
            const avatar = uploadedAvatarRegister || selectedAvatarRegister;

            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username, 
                        password, 
                        nickname, 
                        avatar: avatar
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
                }

                // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°
                saveUserToLocal(data.user);
                updateUserUI();
                closeRegisterModal();
                showToast('æ³¨å†ŒæˆåŠŸï¼', 'success');
                
                // åˆ·æ–°ç•™è¨€åˆ—è¡¨
                await loadMessages();
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showToast(error.message || 'æ³¨å†Œå¤±è´¥', 'error');
            }
        }

        // ========== ç”¨æˆ·è®¾ç½®ç›¸å…³ ==========
        function openUserSettingsModal() {
            const user = getUserInfo();
            if (!user) return;
            
            document.getElementById('userSettingsModal').classList.remove('hidden');
            
            // é‡ç½®ä¸Šä¼ å¤´åƒ
            uploadedAvatarSettings = null;
            document.getElementById('settingsAvatarUpload').value = '';
            
            // å¦‚æœå½“å‰æ˜¯è‡ªå®šä¹‰å¤´åƒï¼ˆURLæ ¼å¼ï¼‰ï¼Œæ˜¾ç¤ºé¢„è§ˆ
            if (user.avatar.startsWith('/uploads/') || user.avatar.startsWith('http')) {
                document.getElementById('settingsAvatarPreview').innerHTML = 
                    `<img src="${API_BASE_URL.replace('/api', '')}${user.avatar}" class="w-full h-full object-cover">`;
                uploadedAvatarSettings = user.avatar;
            } else {
                // é‡ç½®é¢„è§ˆ
                document.getElementById('settingsAvatarPreview').innerHTML = '<i class="fas fa-image text-gray-400 text-2xl"></i>';
            }
            
            // è®¾ç½®å½“å‰å¤´åƒä¸ºé€‰ä¸­çŠ¶æ€ï¼ˆå¦‚æœæ˜¯é¢„è®¾å¤´åƒï¼‰
            selectedAvatarSettings = user.avatar;
            document.querySelectorAll('.avatar-option-settings').forEach(opt => {
                opt.classList.remove('ring-4', 'ring-fish-400', 'ring-rabbit-400', 'ring-purple-400', 'ring-green-400', 'ring-yellow-400', 'ring-pink-400');
            });
            
            const currentAvatarEl = document.querySelector(`.avatar-option-settings[data-avatar="${user.avatar}"]`);
            if (currentAvatarEl) {
                currentAvatarEl.classList.add('ring-4');
                const ringColor = {
                    fish: 'ring-fish-400', rabbit: 'ring-rabbit-400', star: 'ring-purple-400',
                    leaf: 'ring-green-400', sun: 'ring-yellow-400', cloud: 'ring-pink-400'
                }[user.avatar];
                currentAvatarEl.classList.add(ringColor);
            }
        }

        function closeUserSettingsModal() {
            document.getElementById('userSettingsModal').classList.add('hidden');
        }

        async function saveUserSettings() {
            const user = getUserInfo();
            if (!user) return;

            // ç¡®å®šä½¿ç”¨å“ªä¸ªå¤´åƒï¼ˆä¸Šä¼ çš„ä¼˜å…ˆï¼‰
            const avatar = uploadedAvatarSettings || selectedAvatarSettings;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${user.id}/avatar`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ avatar: avatar })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ä¿®æ”¹å¤´åƒå¤±è´¥');
                }

                // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                saveUserToLocal(data.user);
                updateUserUI();
                closeUserSettingsModal();
                showToast('å¤´åƒä¿®æ”¹æˆåŠŸï¼', 'success');
                
                // åˆ·æ–°ç•™è¨€åˆ—è¡¨
                await loadMessages();
            } catch (error) {
                console.error('ä¿®æ”¹å¤´åƒå¤±è´¥:', error);
                showToast(error.message || 'ä¿®æ”¹å¤´åƒå¤±è´¥', 'error');
            }
        }

        // ========== ç™»å‡º ==========
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                clearUserInfo();
                updateUserUI();
                showToast('å·²é€€å‡ºç™»å½•', 'success');
                loadMessages();
            }
        }

        // ========== å‘è¡¨ç•™è¨€ç›¸å…³ ==========
        // æ‰“å¼€å‘è¡¨ç•™è¨€å¼¹çª—
        function openPostModal() {
            const user = getUserInfo();
            
            // æ£€æŸ¥æ˜¯å¦ç™»å½•
            if (!user) {
                showToast('è¯·å…ˆç™»å½•æ‰èƒ½å‘è¡¨ç•™è¨€', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 1000);
                return;
            }
            
            document.getElementById('postModal').classList.remove('hidden');
            document.getElementById('messageContent').value = '';
            document.getElementById('charCount').textContent = '0';
        }

        // å…³é—­å‘è¡¨ç•™è¨€å¼¹çª—
        function closePostModal() {
            document.getElementById('postModal').classList.add('hidden');
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const content = document.getElementById('messageContent').value.trim();
            
            if (!content) {
                showToast('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'error');
                return;
            }

            try {
                const user = getUserInfo();
                
                // å†æ¬¡æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!user) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    closePostModal();
                    openLoginModal();
                    return;
                }

                // æäº¤ç•™è¨€åˆ°åç«¯
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: user.id,
                        nickname: user.nickname,
                        avatar: user.avatar,
                        content: content
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'å‘è¡¨ç•™è¨€å¤±è´¥');
                }

                // åˆ·æ–°æ˜¾ç¤º
                await loadMessages();
                closePostModal();
                showToast('ç•™è¨€å‘è¡¨æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('æäº¤ç•™è¨€å¤±è´¥:', error);
                showToast(error.message || 'å‘è¡¨ç•™è¨€å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç•™è¨€åˆ—è¡¨
        async function loadMessages() {
            try {
                const response = await fetch(`${API_BASE_URL}/messages?limit=100`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'è·å–ç•™è¨€å¤±è´¥');
                }

                const messages = data.data.messages;
                const messageList = document.getElementById('messageList');
                const emptyState = document.getElementById('emptyState');

                if (messages.length === 0) {
                    messageList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                const user = getUserInfo();

                messageList.innerHTML = messages.map(msg => {
                    const isOwn = user && user.id === msg.user_id;
                    const timeStr = formatTime(new Date(msg.created_at).getTime());

                    return `
                        <div class="message-card bg-white/80 backdrop-blur-sm rounded-2xl shadow-md p-5 border border-gray-100">
                            <div class="flex items-start gap-4">
                                <!-- å¤´åƒ -->
                                ${renderAvatar(msg.avatar)}
                                
                                <!-- å†…å®¹åŒº -->
                                <div class="flex-grow min-w-0">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-medium text-gray-800">${escapeHtml(msg.nickname)}</span>
                                            ${isOwn ? '<span class="text-xs bg-fish-100 text-fish-600 px-2 py-0.5 rounded-full">æˆ‘</span>' : ''}
                                        </div>
                                        <span class="text-xs text-gray-400">${timeStr}</span>
                                    </div>
                                    
                                    <p class="text-gray-700 leading-relaxed break-words">${escapeHtml(msg.content)}</p>
                                    
                                    ${isOwn ? `
                                        <div class="mt-3 flex justify-end">
                                            <button onclick="deleteMessage(${msg.id})" class="text-xs text-red-400 hover:text-red-600 transition-colors flex items-center gap-1">
                                                <i class="fas fa-trash-alt"></i>
                                                åˆ é™¤
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
                showToast('åŠ è½½ç•™è¨€å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç•™è¨€
        async function deleteMessage(messageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
                return;
            }

            try {
                const user = getUserInfo();
                if (!user) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/messages/${messageId}?userId=${user.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'åˆ é™¤ç•™è¨€å¤±è´¥');
                }
                
                await loadMessages();
                showToast('ç•™è¨€å·²åˆ é™¤', 'success');
            } catch (error) {
                console.error('åˆ é™¤ç•™è¨€å¤±è´¥:', error);
                showToast(error.message || 'åˆ é™¤ç•™è¨€å¤±è´¥', 'error');
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minute = 60 * 1000;
            const hour = 60 * minute;
            const day = 24 * hour;

            if (diff < minute) {
                return 'åˆšåˆš';
            } else if (diff < hour) {
                return Math.floor(diff / minute) + 'åˆ†é’Ÿå‰';
            } else if (diff < day) {
                return Math.floor(diff / hour) + 'å°æ—¶å‰';
            } else if (diff < 7 * day) {
                return Math.floor(diff / day) + 'å¤©å‰';
            } else {
                const date = new Date(timestamp);
                return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-gradient-to-r from-fish-400 to-rabbit-400';
            toast.className = `fixed bottom-8 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 opacity-0`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
    </script>
</body>
</html>

