<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸©é¦¨ç•™è¨€æ¿ - 1122å®¢å…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fish: {
                            50: '#F0F7FF',
                            100: '#E0F0FF',
                            300: '#99CCF3',
                            400: '#66B3E8',
                        },
                        rabbit: {
                            50: '#FFF5F9',
                            100: '#FFEFF6',
                            300: '#FFC2D1',
                            400: '#FFB0C4',
                        }
                    },
                    fontFamily: {
                        cute: ['"Comic Sans MS"', '"Arial Rounded MT Bold"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style type="text/css">
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2399ccf3' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .message-card {
            transition: all 0.3s ease;
        }
        .message-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-fish-50 via-white to-rabbit-50 bg-pattern min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨è£…é¥°æ¡ -->
    <div class="w-full h-1.5 bg-gradient-to-r from-fish-400 via-rabbit-300 to-fish-300"></div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">
        <!-- æ ‡é¢˜åŒº -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-fish-100 to-rabbit-100 mb-3 shadow-md">
                <i class="fas fa-message text-4xl text-fish-400"></i>
            </div>
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-cute font-bold bg-gradient-to-r from-fish-400 to-rabbit-400 bg-clip-text text-transparent mb-2">
                æ¸©é¦¨ç•™è¨€æ¿
            </h1>
            <p class="text-gray-600 text-sm">åœ¨è¿™é‡Œç•™ä¸‹ä½ çš„å¿ƒæƒ…å’Œç¥ç¦ ğŸ’Œ</p>
        </div>

        <!-- å‘è¡¨ç•™è¨€æŒ‰é’® -->
        <div class="mb-8 text-center">
            <button id="postMessageBtn" class="inline-flex items-center gap-2 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-8 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                <i class="fas fa-pen"></i>
                <span>å‘è¡¨ç•™è¨€</span>
            </button>
        </div>

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div id="messageList" class="space-y-4 mb-8">
            <!-- ç•™è¨€å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="text-center py-16 hidden">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-400 text-lg">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div class="text-center mt-8">
            <a href="1122-A.html" class="inline-flex items-center gap-2 bg-white hover:bg-fish-50 text-gray-800 font-medium py-3 px-6 rounded-full transition-all duration-300 shadow-sm border border-fish-100 hover:shadow-md">
                <i class="fas fa-arrow-left"></i>
                <span>è¿”å›å®¢å…</span>
            </a>
        </div>
    </main>

    <!-- å‘è¡¨ç•™è¨€å¼¹çª— -->
    <div id="postModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-fish-400 to-rabbit-400 text-white p-6 rounded-t-3xl">
                <h2 class="text-2xl font-cute font-bold text-center">å‘è¡¨ç•™è¨€</h2>
            </div>
            
            <div class="p-6">
                <!-- ç”¨æˆ·ä¿¡æ¯è®¾ç½® -->
                <div id="userSetup" class="mb-6">
                    <p class="text-sm text-gray-600 mb-4 text-center">é¦–æ¬¡ç•™è¨€éœ€è¦è®¾ç½®æ˜µç§°å’Œå¤´åƒ</p>
                    
                    <!-- å¤´åƒé€‰æ‹© -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©å¤´åƒ</label>
                        <div class="flex gap-3 flex-wrap justify-center">
                            <div class="avatar-option w-16 h-16 rounded-full bg-gradient-to-br from-fish-300 to-fish-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-fish-400 transition-all" data-avatar="fish">
                                <i class="fas fa-fish text-white text-2xl"></i>
                            </div>
                            <div class="avatar-option w-16 h-16 rounded-full bg-gradient-to-br from-rabbit-300 to-rabbit-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-rabbit-400 transition-all" data-avatar="rabbit">
                                <i class="fas fa-heart text-white text-2xl"></i>
                            </div>
                            <div class="avatar-option w-16 h-16 rounded-full bg-gradient-to-br from-purple-300 to-purple-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-purple-400 transition-all" data-avatar="star">
                                <i class="fas fa-star text-white text-2xl"></i>
                            </div>
                            <div class="avatar-option w-16 h-16 rounded-full bg-gradient-to-br from-green-300 to-green-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-green-400 transition-all" data-avatar="leaf">
                                <i class="fas fa-leaf text-white text-2xl"></i>
                            </div>
                            <div class="avatar-option w-16 h-16 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-yellow-400 transition-all" data-avatar="sun">
                                <i class="fas fa-sun text-white text-2xl"></i>
                            </div>
                            <div class="avatar-option w-16 h-16 rounded-full bg-gradient-to-br from-pink-300 to-pink-400 flex items-center justify-center cursor-pointer border-4 border-transparent hover:border-pink-400 transition-all" data-avatar="cloud">
                                <i class="fas fa-cloud text-white text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- æ˜µç§°è¾“å…¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ˜µç§°</label>
                        <input type="text" id="nicknameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" maxlength="12" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all">
                    </div>
                </div>

                <!-- ç•™è¨€å†…å®¹ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç•™è¨€å†…å®¹</label>
                    <textarea id="messageContent" rows="5" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..." maxlength="500" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-fish-400 focus:ring-2 focus:ring-fish-400/20 focus:outline-none transition-all resize-none"></textarea>
                    <div class="text-right text-sm text-gray-400 mt-1">
                        <span id="charCount">0</span>/500
                    </div>
                </div>

                <!-- æŒ‰é’®ç»„ -->
                <div class="flex gap-3">
                    <button id="cancelBtn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-all duration-300">
                        å–æ¶ˆ
                    </button>
                    <button id="submitBtn" class="flex-1 bg-gradient-to-r from-fish-400 to-rabbit-400 hover:from-fish-300 hover:to-rabbit-300 text-white font-medium py-3 px-6 rounded-xl transition-all duration-300 shadow-lg">
                        å‘è¡¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="py-4 text-center text-gray-500 text-sm">
        <p>ğŸ’• æ¯ä¸€æ¡ç•™è¨€éƒ½æ˜¯çè´µçš„å›å¿† ğŸ’•</p>
    </footer>

    <script>
        // APIé…ç½® - ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€
        const API_BASE_URL = 'http://fish-rabbit.site/api';
        
        // æ•°æ®å­˜å‚¨é”®ï¼ˆåªç”¨äºå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼‰
        const STORAGE_KEYS = {
            USER: 'messageBoard_user'
        };

        // å¤´åƒé…ç½®
        const AVATAR_CONFIG = {
            fish: { icon: 'fa-fish', gradient: 'from-fish-300 to-fish-400' },
            rabbit: { icon: 'fa-heart', gradient: 'from-rabbit-300 to-rabbit-400' },
            star: { icon: 'fa-star', gradient: 'from-purple-300 to-purple-400' },
            leaf: { icon: 'fa-leaf', gradient: 'from-green-300 to-green-400' },
            sun: { icon: 'fa-sun', gradient: 'from-yellow-300 to-yellow-400' },
            cloud: { icon: 'fa-cloud', gradient: 'from-pink-300 to-pink-400' }
        };

        // å½“å‰é€‰æ‹©çš„å¤´åƒ
        let selectedAvatar = 'fish';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();
            initEventListeners();
            checkUserInfo();
        });

        // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
        function checkUserInfo() {
            const user = getUserInfo();
            if (user) {
                document.getElementById('userSetup').classList.add('hidden');
            }
        }

        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            const userStr = localStorage.getItem(STORAGE_KEYS.USER);
            return userStr ? JSON.parse(userStr) : null;
        }

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦å…ˆåœ¨åç«¯æ³¨å†Œï¼‰
        async function saveUserInfo(nickname, avatar) {
            try {
                const response = await fetch(`${API_BASE_URL}/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nickname, avatar })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
                }

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(data.user));
                return data.user;
            } catch (error) {
                console.error('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                throw error;
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // å‘è¡¨ç•™è¨€æŒ‰é’®
            document.getElementById('postMessageBtn').addEventListener('click', openPostModal);

            // å…³é—­å¼¹çª—
            document.getElementById('cancelBtn').addEventListener('click', closePostModal);

            // æäº¤ç•™è¨€
            document.getElementById('submitBtn').addEventListener('click', submitMessage);

            // å¤´åƒé€‰æ‹©
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('ring-4', 'ring-fish-400', 'ring-rabbit-400', 'ring-purple-400', 'ring-green-400', 'ring-yellow-400', 'ring-pink-400');
                    });
                    
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    this.classList.add('ring-4');
                    const avatar = this.dataset.avatar;
                    selectedAvatar = avatar;
                    
                    // æ·»åŠ å¯¹åº”é¢œè‰²çš„ring
                    const ringColor = {
                        fish: 'ring-fish-400',
                        rabbit: 'ring-rabbit-400',
                        star: 'ring-purple-400',
                        leaf: 'ring-green-400',
                        sun: 'ring-yellow-400',
                        cloud: 'ring-pink-400'
                    }[avatar];
                    this.classList.add(ringColor);
                });
            });

            // å­—æ•°ç»Ÿè®¡
            document.getElementById('messageContent').addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
            document.getElementById('postModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePostModal();
                }
            });
        }

        // æ‰“å¼€å‘è¡¨ç•™è¨€å¼¹çª—
        function openPostModal() {
            document.getElementById('postModal').classList.remove('hidden');
            document.getElementById('messageContent').value = '';
            document.getElementById('charCount').textContent = '0';
            
            // å¦‚æœå·²æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œéšè—è®¾ç½®åŒº
            const user = getUserInfo();
            if (user) {
                document.getElementById('userSetup').classList.add('hidden');
                selectedAvatar = user.avatar;
            } else {
                document.getElementById('userSetup').classList.remove('hidden');
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¤´åƒ
                document.querySelector('.avatar-option').click();
            }
        }

        // å…³é—­å‘è¡¨ç•™è¨€å¼¹çª—
        function closePostModal() {
            document.getElementById('postModal').classList.add('hidden');
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const content = document.getElementById('messageContent').value.trim();
            
            if (!content) {
                showToast('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'error');
                return;
            }

            try {
                let user = getUserInfo();
                
                // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦å…ˆè®¾ç½®
                if (!user) {
                    const nickname = document.getElementById('nicknameInput').value.trim();
                    if (!nickname) {
                        showToast('è¯·è¾“å…¥æ˜µç§°', 'error');
                        return;
                    }
                    // å…ˆæ³¨å†Œç”¨æˆ·
                    user = await saveUserInfo(nickname, selectedAvatar);
                }

                // æäº¤ç•™è¨€åˆ°åç«¯
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: user.id,
                        nickname: user.nickname,
                        avatar: user.avatar,
                        content: content
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'å‘è¡¨ç•™è¨€å¤±è´¥');
                }

                // åˆ·æ–°æ˜¾ç¤º
                await loadMessages();
                closePostModal();
                showToast('ç•™è¨€å‘è¡¨æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('æäº¤ç•™è¨€å¤±è´¥:', error);
                showToast(error.message || 'å‘è¡¨ç•™è¨€å¤±è´¥', 'error');
            }
        }

        // åŠ è½½ç•™è¨€åˆ—è¡¨
        async function loadMessages() {
            try {
                const response = await fetch(`${API_BASE_URL}/messages?limit=100`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'è·å–ç•™è¨€å¤±è´¥');
                }

                const messages = data.data.messages;
                const messageList = document.getElementById('messageList');
                const emptyState = document.getElementById('emptyState');

                if (messages.length === 0) {
                    messageList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                const user = getUserInfo();

                messageList.innerHTML = messages.map(msg => {
                    const isOwn = user && user.id === msg.user_id;
                    const avatarConfig = AVATAR_CONFIG[msg.avatar] || AVATAR_CONFIG.fish;
                    const timeStr = formatTime(new Date(msg.created_at).getTime());

                    return `
                        <div class="message-card bg-white/80 backdrop-blur-sm rounded-2xl shadow-md p-5 border border-gray-100">
                            <div class="flex items-start gap-4">
                                <!-- å¤´åƒ -->
                                <div class="flex-shrink-0 w-12 h-12 rounded-full bg-gradient-to-br ${avatarConfig.gradient} flex items-center justify-center shadow-md">
                                    <i class="fas ${avatarConfig.icon} text-white text-xl"></i>
                                </div>
                                
                                <!-- å†…å®¹åŒº -->
                                <div class="flex-grow min-w-0">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-2">
                                            <span class="font-medium text-gray-800">${escapeHtml(msg.nickname)}</span>
                                            ${isOwn ? '<span class="text-xs bg-fish-100 text-fish-600 px-2 py-0.5 rounded-full">æˆ‘</span>' : ''}
                                        </div>
                                        <span class="text-xs text-gray-400">${timeStr}</span>
                                    </div>
                                    
                                    <p class="text-gray-700 leading-relaxed break-words">${escapeHtml(msg.content)}</p>
                                    
                                    ${isOwn ? `
                                        <div class="mt-3 flex justify-end">
                                            <button onclick="deleteMessage(${msg.id})" class="text-xs text-red-400 hover:text-red-600 transition-colors flex items-center gap-1">
                                                <i class="fas fa-trash-alt"></i>
                                                åˆ é™¤
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
                showToast('åŠ è½½ç•™è¨€å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç•™è¨€
        async function deleteMessage(messageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
                return;
            }

            try {
                const user = getUserInfo();
                if (!user) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/messages/${messageId}?userId=${user.id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'åˆ é™¤ç•™è¨€å¤±è´¥');
                }
                
                await loadMessages();
                showToast('ç•™è¨€å·²åˆ é™¤', 'success');
            } catch (error) {
                console.error('åˆ é™¤ç•™è¨€å¤±è´¥:', error);
                showToast(error.message || 'åˆ é™¤ç•™è¨€å¤±è´¥', 'error');
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minute = 60 * 1000;
            const hour = 60 * minute;
            const day = 24 * hour;

            if (diff < minute) {
                return 'åˆšåˆš';
            } else if (diff < hour) {
                return Math.floor(diff / minute) + 'åˆ†é’Ÿå‰';
            } else if (diff < day) {
                return Math.floor(diff / hour) + 'å°æ—¶å‰';
            } else if (diff < 7 * day) {
                return Math.floor(diff / day) + 'å¤©å‰';
            } else {
                const date = new Date(timestamp);
                return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-gradient-to-r from-fish-400 to-rabbit-400';
            toast.className = `fixed bottom-8 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all duration-300 opacity-0`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0');
                toast.classList.add('opacity-100');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
    </script>
</body>
</html>

