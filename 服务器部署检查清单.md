# 服务器部署检查清单

## ✅ 已修复的API配置问题

### 1. API基础URL
- **auth-modal.js**: `https://fish-rabbit.site/api` ✅
- **520.html**: 所有API调用已更新为完整HTTPS URL ✅
- **1122-A.html**: 权限检查API已更新 ✅
- **test_api.html**: 测试API已更新 ✅

### 2. 路由冲突
- **exam.js**: 权限路由已改为 `/exam/users/:id/permissions` ✅
- **前端调用**: 所有相关调用已更新 ✅

## 🔧 服务器部署步骤

### 1. 文件上传
确保以下文件已上传到服务器：
- [ ] 所有HTML文件
- [ ] auth-modal.js
- [ ] backend/ 目录及所有文件

### 2. 数据库设置
```bash
# 在服务器上运行
mysql -u root -p < backend/config/setup_fish1_admin.sql
```

### 3. 后端服务启动
```bash
cd backend
npm install
npm start
```

### 4. 验证部署
- [ ] 访问 https://fish-rabbit.site/health
- [ ] 访问 https://fish-rabbit.site (主页)
- [ ] 测试登录功能 (fish1/fish1)
- [ ] 测试520房间功能
- [ ] 测试1122-A卧室权限

## 🚨 常见问题排查

### 问题1：健康检查失败
**症状**: 无法访问 https://fish-rabbit.site/health
**可能原因**:
- 后端服务未启动
- 端口配置错误
- 防火墙阻止
- Nginx配置问题

**解决方案**:
```bash
# 检查服务状态
ps aux | grep node

# 检查端口占用
netstat -tlnp | grep :3000

# 检查防火墙
sudo ufw status
```

### 问题2：登录返回HTML而不是JSON
**症状**: 控制台显示 "Unexpected token '<'"
**可能原因**:
- API路径错误
- 服务器返回错误页面
- CORS问题

**解决方案**:
- 检查API路径是否正确
- 查看服务器日志
- 验证CORS配置

### 问题3：权限检查失败
**症状**: 无法获取用户权限
**可能原因**:
- 数据库连接问题
- 用户权限未正确设置
- JWT token问题

**解决方案**:
```sql
-- 检查fish1用户权限
SELECT u.username, GROUP_CONCAT(up.permission) as permissions
FROM users u
LEFT JOIN user_permissions up ON u.id = up.user_id
WHERE u.username = 'fish1'
GROUP BY u.id;
```

## 📋 测试清单

### 基础功能测试
- [ ] 主页加载正常
- [ ] 登录弹窗正常显示
- [ ] 用户注册功能
- [ ] 用户登录功能

### 权限功能测试
- [ ] fish1用户登录成功
- [ ] 520房间显示管理员功能
- [ ] 1122-A卧室权限检查正常
- [ ] 题目管理功能正常

### API接口测试
- [ ] /health 接口正常
- [ ] /api/users/login 接口正常
- [ ] /api/exam/users/:id/permissions 接口正常
- [ ] 所有exam相关接口正常

## 🔍 调试工具

### 1. 浏览器开发者工具
- Network标签查看API请求
- Console标签查看错误信息
- Application标签查看localStorage

### 2. 服务器日志
```bash
# 查看PM2日志
pm2 logs fish-backend

# 查看系统日志
tail -f /var/log/nginx/error.log
```

### 3. 数据库检查
```sql
-- 检查用户表
SELECT * FROM users WHERE username = 'fish1';

-- 检查权限表
SELECT * FROM user_permissions WHERE user_id = (SELECT id FROM users WHERE username = 'fish1');

-- 检查题目表
SELECT COUNT(*) FROM exam_questions;
```

## 📞 技术支持

如果问题仍然存在，请提供：
1. 浏览器控制台完整错误信息
2. 服务器日志截图
3. 网络请求详情
4. 数据库查询结果
