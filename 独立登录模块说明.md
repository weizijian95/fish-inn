# 独立登录模块说明

## 概述

已将登录/注册功能提取为独立的模块，现在点击"登录/注册"按钮时会在当前页面弹出登录弹窗，而不是跳转到其他页面。

## 核心文件

### auth-modal.js

这是独立的登录/注册模块，包含：

- **登录弹窗**：用户名和密码登录
- **注册弹窗**：包含用户名、密码、昵称、头像选择
- **头像选择**：6 种预设头像 + 自定义上传
- **Toast 提示**：显示操作结果
- **事件系统**：登录成功后触发 `userLoggedIn` 事件

## 使用方法

### 1. 在 HTML 中引入模块

```html
<!-- 在 </body> 标签前引入 -->
<script src="auth-modal.js"></script>
```

### 2. 打开登录弹窗

```javascript
// 打开登录弹窗
openAuthModal('login');

// 或者打开注册弹窗
openAuthModal('register');
```

### 3. 监听登录成功事件（可选）

```javascript
window.addEventListener('userLoggedIn', (event) => {
    console.log('用户已登录:', event.detail);
    // 刷新页面状态或执行其他操作
});
```

## 已修改的页面

所有页面都已更新使用新的登录模块：

### 1. index.html - 精灵客栈首页
- ✅ 引入 auth-modal.js
- ✅ goToLogin() 调用 openAuthModal()

### 2. 1122.html - 小鱼和兔子的小屋
- ✅ 引入 auth-modal.js
- ✅ goToLogin() 调用 openAuthModal()

### 3. 1122-A.html - 客厅
- ✅ 引入 auth-modal.js
- ✅ goToLogin() 调用 openAuthModal()

### 4. 1121.html - 狮子和哑铃的小屋
- ✅ 引入 auth-modal.js
- ✅ goToLogin() 调用 openAuthModal()

### 5. 1122-A-album.html - 相册
- ✅ 引入 auth-modal.js
- ✅ "去登录"按钮调用 openAuthModal()
- ✅ 监听登录成功事件，自动刷新页面状态

## 功能特性

### 🎨 美观的弹窗设计

- 毛玻璃效果背景
- 蓝粉渐变主题
- 流畅的动画效果
- 响应式设计

### 🔐 完整的登录/注册流程

**登录弹窗：**
- 用户名输入
- 密码输入
- 支持回车键提交
- 可切换到注册

**注册弹窗：**
- 用户名（最多 50 字符）
- 密码
- 昵称（最多 50 字符）
- 6 种预设头像可选
- 支持上传自定义头像（最大 5MB）
- 可切换到登录

### 📸 头像功能

**预设头像：**
- 🐟 小鱼（蓝色）
- ❤️ 兔子（粉色）
- ⭐ 星星（紫色）
- 🍃 叶子（绿色）
- ☀️ 太阳（黄色）
- ☁️ 云朵（粉色）

**自定义头像：**
- 支持 JPG、PNG、GIF 格式
- 文件大小限制 5MB
- 实时预览
- 自动上传到服务器

### ✨ 用户体验优化

1. **无需跳转**：在当前页面完成登录
2. **自动更新**：登录成功后自动更新页面状态
3. **智能提示**：Toast 提示显示操作结果
4. **键盘支持**：支持回车键提交登录
5. **表单验证**：完善的输入验证

## API 接口

模块使用以下 API 接口：

### 登录
```
POST /api/users/login
Body: { username, password }
Response: { user, token }
```

### 注册
```
POST /api/users/register
Body: { username, password, nickname, avatar }
Response: { user, token }
```

### 上传头像
```
POST /api/upload/avatar
FormData: avatar (file)
Response: { avatarUrl }
```

## 数据存储

登录成功后，用户信息保存在 localStorage：

```javascript
localStorage.setItem('user', JSON.stringify({
    id: 1,
    username: "fish",
    nickname: "小鱼",
    avatar: "https://..."
}));

localStorage.setItem('token', "eyJhbGciOiJIUzI1NiIsInR...");
```

## 事件系统

### userLoggedIn 事件

登录或注册成功后触发，携带用户信息：

```javascript
window.addEventListener('userLoggedIn', (event) => {
    const user = event.detail;
    console.log('用户ID:', user.id);
    console.log('昵称:', user.nickname);
    console.log('头像:', user.avatar);
});
```

## 与旧系统的区别

| 功能 | 旧系统 | 新系统 |
|------|--------|--------|
| 登录方式 | 跳转到留言板页面 | 当前页面弹窗 |
| 用户体验 | 需要页面跳转 | 无缝体验 |
| 代码复用 | 每个页面独立 | 统一模块 |
| 维护性 | 需要修改多个文件 | 只需修改一个文件 |
| 返回机制 | 需要 returnTo 参数 | 不需要跳转 |

## 优势

1. **更好的用户体验**：无需跳转页面
2. **代码复用**：所有页面共用一个登录模块
3. **易于维护**：只需维护 auth-modal.js
4. **功能完整**：包含登录、注册、头像上传等全部功能
5. **事件驱动**：支持自定义事件，方便扩展

## 自定义配置

### 修改 API 地址

在 auth-modal.js 顶部修改：

```javascript
const API_BASE_URL = 'http://your-api-server.com/api';
```

### 修改主题颜色

在 auth-modal.js 的 HTML 中修改 Tailwind 类：

```javascript
// 修改渐变色
from-blue-400 to-pink-400  // 改为你的颜色
```

### 添加更多预设头像

在 createAuthModal() 函数中添加头像选项：

```html
<div class="auth-avatar-option ..." data-avatar="your-avatar-id">
    <i class="fas fa-your-icon ..."></i>
</div>
```

然后在 submitAuthRegister() 中添加映射：

```javascript
const avatarMap = {
    'your-avatar-id': 'https://your-avatar-url.com/...',
    // ...
};
```

## 故障排查

### 问题：点击登录按钮没反应

**解决方案：**
1. 检查是否正确引入 auth-modal.js
2. 检查浏览器控制台是否有错误
3. 确认 openAuthModal 函数是否定义

### 问题：登录成功但页面不更新

**解决方案：**
1. 确保页面有 updateUserUI() 函数
2. 添加 userLoggedIn 事件监听
3. 检查 localStorage 是否正确保存

### 问题：头像上传失败

**解决方案：**
1. 检查文件大小是否超过 5MB
2. 检查文件格式是否为图片
3. 检查后端 /api/upload/avatar 接口是否正常

## 未来优化建议

- [ ] 添加找回密码功能
- [ ] 支持第三方登录（微信、QQ等）
- [ ] 添加验证码功能
- [ ] 支持邮箱注册
- [ ] 添加密码强度检测
- [ ] 支持记住登录状态
- [ ] 添加更多头像选项
- [ ] 支持头像裁剪功能

## 注意事项

1. auth-modal.js 必须在页面 JavaScript 代码之前引入
2. 确保后端 API 支持跨域（CORS）
3. 建议在生产环境使用 HTTPS
4. 定期检查 localStorage 存储空间
5. 考虑添加 token 过期处理机制

