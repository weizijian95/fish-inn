# 登录问题排查指南

## 问题描述
登录时显示：`Unexpected token '<', "<html> <h"... is not valid JSON`

## 问题原因
这个错误表示前端收到了HTML响应而不是JSON数据，通常是因为：
1. API路径错误
2. 后端服务未启动
3. 网络连接问题

## 已修复的问题

### 1. API路径冲突
- **问题**：exam.js中的`/users/:id/permissions`路由与用户路由冲突
- **修复**：改为`/exam/users/:id/permissions`
- **影响文件**：`backend/routes/exam.js`, `1122-A.html`, `520.html`

### 2. API基础URL错误
- **问题**：auth-modal.js中使用外部域名`https://fish-rabbit.site/api`
- **修复**：改为本地开发服务器`http://localhost:3000/api`
- **影响文件**：`auth-modal.js`

## 解决步骤

### 1. 启动后端服务
```bash
# 在腾讯云服务器上启动
cd backend
npm install
npm start

# 或使用PM2管理进程
pm2 start server.js --name "fish-backend"
```

### 2. 验证服务状态
打开浏览器访问：https://fish-rabbit.site/health
应该看到：
```json
{
  "status": "ok",
  "message": "精灵客栈后端服务运行中"
}
```

### 3. 测试API
使用测试页面：`test_api.html`
- 点击"测试健康检查"按钮
- 点击"测试登录"按钮

### 4. 检查数据库
确保数据库已正确设置：
```bash
mysql -u root -p < backend/config/setup_fish1_admin.sql
```

## 常见问题

### 问题1：端口被占用
**错误信息**：`EADDRINUSE: address already in use :::3000`
**解决方案**：
```bash
# 查找占用端口的进程
netstat -ano | findstr :3000

# 结束进程（替换PID）
taskkill /PID <进程ID> /F
```

### 问题2：数据库连接失败
**错误信息**：`❌ 数据库连接失败`
**解决方案**：
1. 确保MySQL服务正在运行
2. 检查数据库配置
3. 运行数据库初始化脚本

### 问题3：CORS错误
**错误信息**：`Access to fetch at '...' from origin '...' has been blocked by CORS policy`
**解决方案**：
- 后端已配置CORS中间件
- 确保使用正确的API地址

## 验证修复

### 1. 登录测试
1. 打开 `index.html`
2. 点击"登录/注册"
3. 输入用户名：`fish1`，密码：`fish1`
4. 应该成功登录

### 2. 权限测试
1. 登录后进入520房间
2. 应该能看到"新增题目"和"设置考试"按钮
3. 在1122-A页面点击"前往卧室"应该成功

### 3. API测试
使用浏览器开发者工具：
1. 打开Network标签
2. 尝试登录
3. 检查API请求是否返回JSON数据

## 调试技巧

### 1. 查看控制台错误
按F12打开开发者工具，查看Console标签的错误信息

### 2. 检查网络请求
在Network标签中查看API请求的响应内容

### 3. 后端日志
查看后端控制台输出的日志信息

## 联系支持

如果问题仍然存在，请提供：
1. 浏览器控制台错误信息
2. 后端服务日志
3. 网络请求详情
