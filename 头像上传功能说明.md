# 头像上传功能说明

## 功能概述

用户现在可以上传自定义头像图片，不再局限于预设的6个头像。

## 主要功能

### 1. 上传自定义头像
- 注册时可以上传自定义头像
- 登录后可以在个人设置中修改头像为自定义图片
- 支持的格式：JPG、PNG、GIF、WebP
- 文件大小限制：最大 5MB
- 图片会自动上传到服务器并保存

### 2. 预设头像仍然可用
- 用户仍然可以选择6个预设的可爱头像
- 预设头像和自定义头像可以随时切换

### 3. 头像显示
- 自定义头像会在所有地方正确显示
- 包括：用户信息栏、留言列表等

## 安装步骤

### 1. 安装依赖
进入 `backend` 目录，安装新的依赖包：

```bash
cd backend
npm install
```

这将安装 `multer` 文件上传中间件。

### 2. 创建上传目录
上传的头像会保存在 `backend/uploads/avatars/` 目录中。该目录会在首次上传时自动创建，无需手动创建。

### 3. 重启服务器
安装依赖后，重启后端服务器：

```bash
cd backend
npm start
# 或开发模式
npm run dev
```

## 技术实现

### 后端改动

1. **新增依赖**：`backend/package.json`
   - 添加了 `multer` 用于处理文件上传

2. **新增路由**：`backend/routes/upload.js`
   - `POST /api/upload/avatar` - 上传头像接口
   - 文件验证（类型、大小）
   - 自动生成唯一文件名
   - 返回文件访问路径

3. **更新服务器**：`backend/server.js`
   - 添加静态文件服务 `/uploads`
   - 注册上传路由

### 前端改动

1. **界面更新**：`1122-A-board.html`
   - 注册弹窗：添加文件上传和预览区域
   - 个人设置弹窗：添加文件上传和预览区域
   - 实时图片预览功能

2. **功能实现**
   - 文件选择和验证
   - 图片预览（使用 FileReader API）
   - FormData 上传到服务器
   - 头像显示逻辑更新（支持 URL 格式）
   - 优先使用上传的头像，其次使用预设头像

3. **头像渲染**
   - 自动识别头像类型（预设 vs 自定义）
   - 预设头像：显示图标和渐变背景
   - 自定义头像：显示用户上传的图片

## 使用流程

### 注册时上传头像
1. 点击"注册"按钮
2. 填写用户名、密码、昵称
3. 可以选择预设头像，或点击"选择图片"上传自定义头像
4. 上传后会显示预览
5. 点击"注册"完成注册

### 修改头像
1. 登录后点击右上角的齿轮图标⚙️
2. 可以选择预设头像，或点击"选择图片"上传新头像
3. 上传后会显示预览
4. 点击"保存"更新头像

## 文件结构

```
backend/
├── routes/
│   └── upload.js          # 新增：上传路由
├── uploads/               # 新增：上传文件存储目录
│   └── avatars/          # 头像文件存储
│       └── avatar-*.jpg  # 上传的头像文件
├── package.json          # 更新：添加 multer 依赖
└── server.js             # 更新：添加静态文件服务

1122-A-board.html         # 更新：添加上传界面和逻辑
```

## API 接口

### 上传头像
**请求**
```
POST /api/upload/avatar
Content-Type: multipart/form-data

Body:
- avatar: File (图片文件)
```

**响应**
```json
{
  "success": true,
  "avatarUrl": "/uploads/avatars/avatar-1234567890-123456789.jpg",
  "filename": "avatar-1234567890-123456789.jpg"
}
```

**错误响应**
```json
{
  "error": "错误信息"
}
```

## 注意事项

1. **文件存储**：头像文件保存在服务器本地文件系统，部署时需要考虑持久化存储
2. **文件大小**：限制为 5MB，可在 `backend/routes/upload.js` 中调整
3. **文件类型**：只允许图片格式（JPEG, PNG, GIF, WebP）
4. **文件命名**：使用时间戳+随机数生成唯一文件名，避免冲突
5. **访问路径**：上传的图片通过 `/uploads/avatars/文件名` 访问
6. **旧数据兼容**：已有的预设头像用户不受影响

## 可选优化

如果需要更好的生产环境支持，可以考虑：

1. **云存储**：使用阿里云 OSS、七牛云等云存储服务
2. **图片压缩**：使用 sharp 等库进行图片压缩和优化
3. **CDN加速**：通过 CDN 加速图片访问
4. **文件清理**：定期清理未使用的头像文件
5. **HTTPS**：生产环境使用 HTTPS 保护图片传输

## 故障排除

### 上传失败
- 检查文件大小是否超过 5MB
- 检查文件格式是否为图片
- 检查服务器是否有写入权限

### 图片无法显示
- 检查 `backend/uploads/avatars/` 目录是否存在
- 检查服务器静态文件服务是否正常
- 检查文件路径是否正确

### 目录权限问题
确保服务器进程对 uploads 目录有读写权限：
```bash
chmod -R 755 backend/uploads
```

