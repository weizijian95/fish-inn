# 统一登录系统说明

## 功能概述

所有页面现在都添加了统一的登录/注册功能，用户可以在任意页面登录，登录成功后会自动返回原页面。

## 已实现的功能

### 1. 全站用户状态栏

所有页面右上角都添加了用户状态栏：

- **未登录状态**：显示"登录/注册"按钮
- **已登录状态**：显示用户头像、昵称和退出按钮

### 2. 智能登录跳转

- 点击任意页面的"登录/注册"按钮，会跳转到登录页面
- 跳转时携带当前页面地址作为参数（`returnTo`）
- 登录或注册成功后，自动返回原页面
- 如果从其他页面跳转过来，登录页面会自动打开登录弹窗

### 3. 全局登录状态同步

- 使用 localStorage 存储用户信息和 token
- 所有页面共享登录状态
- 退出登录后，所有页面状态同步更新

## 修改的页面列表

### 1. index.html (精灵客栈首页)
- ✅ 添加用户状态栏
- ✅ 添加登录跳转功能
- ✅ 添加退出登录功能

### 2. 1122.html (小鱼和兔子的小屋)
- ✅ 添加用户状态栏（蓝粉色主题）
- ✅ 添加登录跳转功能
- ✅ 添加退出登录功能

### 3. 1122-A.html (客厅)
- ✅ 添加用户状态栏（蓝粉色主题）
- ✅ 添加登录跳转功能
- ✅ 添加退出登录功能

### 4. 1121.html (狮子和哑铃的小屋)
- ✅ 添加用户状态栏（暖橙色主题）
- ✅ 添加登录跳转功能
- ✅ 添加退出登录功能

### 5. 1122-A-board.html (留言板/登录页面)
- ✅ 已有完整的登录/注册功能
- ✅ 支持 returnTo 参数，登录后返回原页面
- ✅ 自动打开登录弹窗（当有 returnTo 参数时）

### 6. 1122-A-album.html (相册)
- ✅ 已有登录提示
- ✅ 点击"去登录"跳转到登录页面，并携带返回地址

## 使用流程示例

### 场景 1：从首页登录

1. 用户访问 `index.html`
2. 看到右上角"登录/注册"按钮
3. 点击按钮，跳转到 `1122-A-board.html?returnTo=index.html`
4. 登录弹窗自动打开
5. 完成登录或注册
6. 自动返回 `index.html`
7. 右上角显示用户头像和昵称

### 场景 2：从相册登录

1. 用户访问 `1122-A-album.html`（未登录）
2. 看到提示："请先登录才能上传和管理照片哦~ 💕"
3. 点击"去登录"按钮
4. 跳转到 `1122-A-board.html?returnTo=1122-A-album.html`
5. 登录弹窗自动打开
6. 完成登录或注册
7. 自动返回 `1122-A-album.html`
8. 可以立即上传照片

### 场景 3：在各页面之间切换

1. 用户在 `index.html` 登录
2. 跳转到 `1122.html`，自动显示已登录状态
3. 再跳转到 `1122-A.html`，继续保持登录状态
4. 访问相册 `1122-A-album.html`，可以直接上传照片
5. 在任意页面点击退出，所有页面状态同步更新

## 技术实现细节

### 用户信息存储

```javascript
// 存储在 localStorage
{
    "user": {
        "id": 1,
        "username": "fish",
        "nickname": "小鱼",
        "avatar": "https://..."
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 登录跳转机制

```javascript
// 跳转到登录页面，携带当前页面路径
function goToLogin() {
    window.location.href = '1122-A-board.html?returnTo=' + 
        encodeURIComponent(window.location.pathname);
}

// 登录成功后检查并返回
const urlParams = new URLSearchParams(window.location.search);
const returnTo = urlParams.get('returnTo');
if (returnTo) {
    setTimeout(() => {
        window.location.href = returnTo;
    }, 500);
}
```

### 用户状态检查

```javascript
// 从 localStorage 获取用户信息
function getUserInfo() {
    const userStr = localStorage.getItem('user');
    return userStr ? JSON.parse(userStr) : null;
}

// 更新页面UI
function updateUserUI() {
    const user = getUserInfo();
    if (user) {
        // 显示已登录状态
        document.getElementById('userNickname').textContent = user.nickname;
        document.getElementById('userAvatar').src = user.avatar;
    } else {
        // 显示未登录状态
    }
}
```

## 样式适配

每个页面的用户状态栏都适配了各自的主题色：

| 页面 | 主题色 | 按钮颜色 |
|------|--------|---------|
| index.html | 靛蓝色 | 灰色边框白底 |
| 1122.html | 蓝粉色 | fish-400/rabbit-300 |
| 1122-A.html | 蓝粉色 | fish-400/rabbit-300 |
| 1121.html | 暖橙色 | warm-600 |

## 优势特点

1. **无缝体验**：登录后自动返回原页面，不需要手动导航
2. **全局同步**：所有页面共享登录状态
3. **智能提示**：自动打开登录弹窗，减少操作步骤
4. **样式统一**：每个页面的登录按钮都适配了页面主题
5. **安全可靠**：使用 JWT token 认证

## 注意事项

1. 用户信息存储在浏览器的 localStorage 中
2. 清除浏览器数据会导致登录状态丢失
3. Token 有效期由后端设置，过期后需要重新登录
4. 建议定期备份重要数据

## 未来优化建议

- [ ] 添加"记住我"功能，延长登录有效期
- [ ] 实现自动刷新 token 机制
- [ ] 添加登录状态过期提示
- [ ] 支持第三方登录（微信、QQ等）
- [ ] 添加用户个人中心页面
- [ ] 实现跨标签页的状态同步

#重启PM2
# 查看 PM2 进程列表
pm2 list

# 停止所有 PM2 进程
pm2 stop all

# 删除所有 PM2 进程（彻底停止自动重启）
pm2 delete all

# 清理 PM2
pm2 kill