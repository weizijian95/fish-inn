<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>520æˆ¿é—´ - çˆ±çš„æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- é…ç½®ä¸“å±æ¸©é¦¨è‰²è°ƒï¼ˆç²‰çº¢ç³»ï¼‰ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        love: {
                            50: '#FFF0F5',
                            100: '#FFE4EC',
                            200: '#FFB3C6',
                            300: '#FF8FA3',
                            400: '#FF6B8A',
                            500: '#FF477E',
                            600: '#E63946',
                            700: '#D62828',
                            800: '#B71C1C',
                        },
                        heart: {
                            50: '#FDF2F8',
                            100: '#FCE7F3',
                            200: '#FBCFE8',
                            300: '#F9A8D4',
                            400: '#F472B6',
                            500: '#EC4899',
                            600: '#DB2777',
                            700: '#BE185D',
                            800: '#9D174D',
                        }
                    },
                    fontFamily: {
                        cute: ['"Comic Sans MS"', '"Arial Rounded MT Bold"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style type="text/css">
        @layer utilities {
            .bg-pattern {
                background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ff6b8a' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3Ccircle cx='10' cy='10' r='2'/%3E%3Ccircle cx='50' cy='10' r='2'/%3E%3Ccircle cx='10' cy='50' r='2'/%3E%3Ccircle cx='50' cy='50' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            }
            .float {
                animation: float 3s ease-in-out infinite;
            }
            @keyframes float {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
            }
            .bounce-slow {
                animation: bounce-slow 2s ease-in-out infinite;
            }
            @keyframes bounce-slow {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            .heart-beat {
                animation: heart-beat 1.5s ease-in-out infinite;
            }
            @keyframes heart-beat {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-love-50 via-white to-heart-50 bg-pattern min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨è£…é¥°æ¡ -->
    <div class="w-full h-1.5 bg-gradient-to-r from-love-400 via-heart-300 to-love-300"></div>

    <!-- ç”¨æˆ·çŠ¶æ€æ  -->
    <div class="container mx-auto px-6 py-4 max-w-4xl">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-heart text-love-400 text-2xl heart-beat"></i>
                <span class="text-love-600 font-bold text-lg">520æˆ¿é—´ - çˆ±çš„æµ‹è¯•</span>
            </div>
            
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div id="userInfo" class="hidden">
                <div class="flex items-center gap-2 bg-white/80 rounded-full py-2 px-4 shadow-sm border border-love-200">
                    <img id="userAvatar" src="" alt="å¤´åƒ" class="w-8 h-8 rounded-full">
                    <span id="userNickname" class="text-gray-700 font-medium"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow container mx-auto px-6 py-10 max-w-4xl">
        <!-- æˆ¿é—´æ ‡é¢˜ -->
        <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-32 h-32 rounded-full bg-gradient-to-br from-love-100 to-heart-100 mb-4 shadow-lg">
                <i class="fas fa-heart text-6xl text-love-400 heart-beat"></i>
            </div>
            <h1 class="text-[clamp(2rem,6vw,3rem)] font-cute font-bold bg-gradient-to-r from-love-400 to-heart-400 bg-clip-text text-transparent mb-2">
                520æˆ¿é—´
            </h1>
            <p class="text-gray-600 text-[clamp(1rem,3vw,1.2rem)]">
                ğŸ’• çˆ±çš„æµ‹è¯•ï¼Œè€ƒéªŒçœŸå¿ƒçš„æ—¶åˆ» ğŸ’•
            </p>
        </div>

        <!-- åŠŸèƒ½åŒºåŸŸ -->
        <div id="mainContent">
            <!-- å®¢æ ˆä¸»äººåŠŸèƒ½ -->
            <div id="adminPanel" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- æ–°å¢é¢˜ç›® -->
                    <button onclick="showAddQuestionModal()" class="bg-gradient-to-br from-love-100 to-love-50 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-love-200 hover:shadow-2xl transition-all duration-300 transform hover:scale-105 cursor-pointer">
                        <div class="text-center mb-4">
                            <i class="fas fa-plus-circle text-4xl text-love-400 bounce-slow"></i>
                        </div>
                        <h3 class="text-xl font-cute font-bold text-gray-800 mb-2 text-center">æ–°å¢é¢˜ç›®</h3>
                        <p class="text-gray-600 text-center text-sm">
                            æ·»åŠ æ–°çš„æµ‹è¯•é¢˜ç›® âœ¨
                        </p>
                    </button>

                    <!-- ç®¡ç†é¢˜ç›® -->
                    <button onclick="showQuestionManagementModal()" class="bg-gradient-to-br from-heart-100 to-heart-50 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-heart-200 hover:shadow-2xl transition-all duration-300 transform hover:scale-105 cursor-pointer">
                        <div class="text-center mb-4">
                            <i class="fas fa-list text-4xl text-heart-400 bounce-slow" style="animation-delay: 0.3s"></i>
                        </div>
                        <h3 class="text-xl font-cute font-bold text-gray-800 mb-2 text-center">ç®¡ç†é¢˜ç›®</h3>
                        <p class="text-gray-600 text-center text-sm">
                            æŸ¥çœ‹å’Œåˆ é™¤é¢˜ç›® ğŸ“
                        </p>
                    </button>

                    <!-- è®¾ç½®è€ƒè¯• -->
                    <button onclick="showExamSettingsModal()" class="bg-gradient-to-br from-love-100 to-love-50 backdrop-blur-sm rounded-2xl shadow-lg p-6 border border-love-200 hover:shadow-2xl transition-all duration-300 transform hover:scale-105 cursor-pointer">
                        <div class="text-center mb-4">
                            <i class="fas fa-cog text-4xl text-love-400 bounce-slow" style="animation-delay: 0.3s"></i>
                        </div>
                        <h3 class="text-xl font-cute font-bold text-gray-800 mb-2 text-center">è®¾ç½®è€ƒè¯•</h3>
                        <p class="text-gray-600 text-center text-sm">
                            é…ç½®è€ƒè¯•è§„åˆ™å’Œæƒé™ ğŸ¯
                        </p>
                    </button>
                </div>
            </div>

            <!-- æ™®é€šç”¨æˆ·åŠŸèƒ½ -->
            <div id="userPanel" class="text-center">
                <div class="bg-gradient-to-r from-love-100/50 to-heart-100/50 backdrop-blur-sm rounded-2xl shadow-md p-8 mb-8 border border-love-200/30">
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <i class="fas fa-graduation-cap text-love-400 text-3xl heart-beat"></i>
                        <h3 class="text-2xl font-cute font-bold text-gray-800">å‚åŠ è€ƒè¯•</h3>
                        <i class="fas fa-heart text-heart-400 text-3xl heart-beat"></i>
                    </div>
                    <p class="text-gray-700 text-lg mb-6">
                        é€šè¿‡çˆ±çš„æµ‹è¯•ï¼Œè¯æ˜ä½ çš„çœŸå¿ƒ<br>
                        <span class="text-love-400 font-medium">ç­”å¯¹è¶³å¤Ÿé¢˜ç›®å³å¯è·å¾—ç‰¹æ®Šæƒé™ï¼</span>
                    </p>
                    <button onclick="startExam()" class="inline-flex items-center gap-2 bg-gradient-to-r from-love-400 to-heart-400 hover:from-love-500 hover:to-heart-500 text-white font-bold py-4 px-8 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-play text-xl"></i>
                        <span class="text-lg">å¼€å§‹è€ƒè¯•</span>
                        <i class="fas fa-heart text-lg animate-pulse"></i>
                    </button>
                </div>
            </div>

            <!-- è¿”å›æŒ‰é’® -->
            <div class="text-center">
                <button onclick="goBack()" class="inline-flex items-center gap-2 bg-white hover:bg-love-50 text-gray-800 font-medium py-3 px-6 rounded-full transition-all duration-300 shadow-sm border border-love-100 hover:shadow-md">
                    <i class="fas fa-arrow-left"></i>
                    <span>è¿”å›å¤§å ‚</span>
                </button>
            </div>
        </div>

        <!-- è€ƒè¯•åŒºåŸŸ -->
        <div id="examArea" class="hidden">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-8 border border-love-200">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-cute font-bold text-gray-800 mb-2">çˆ±çš„æµ‹è¯•</h2>
                    <div id="examProgress" class="text-love-600 font-medium"></div>
                </div>
                
                <div id="questionContainer">
                    <!-- é¢˜ç›®å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="flex justify-center gap-4 mt-8">
                    <button onclick="submitExam()" id="submitBtn" class="hidden inline-flex items-center gap-2 bg-gradient-to-r from-love-400 to-heart-400 hover:from-love-500 hover:to-heart-500 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl">
                        <i class="fas fa-check"></i>
                        <span>æäº¤ç­”æ¡ˆ</span>
                    </button>
                    <button onclick="cancelExam()" class="inline-flex items-center gap-2 bg-gray-400 hover:bg-gray-500 text-white font-medium py-3 px-6 rounded-full transition-all duration-300">
                        <i class="fas fa-times"></i>
                        <span>å–æ¶ˆè€ƒè¯•</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div id="resultArea" class="hidden">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg p-8 border border-love-200">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-cute font-bold text-gray-800 mb-4">è€ƒè¯•ç»“æœ</h2>
                    <div id="resultContent">
                        <!-- ç»“æœå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="goBackToMain()" class="inline-flex items-center gap-2 bg-gradient-to-r from-love-400 to-heart-400 hover:from-love-500 hover:to-heart-500 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl">
                        <i class="fas fa-home"></i>
                        <span>è¿”å›ä¸»é¡µ</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="py-4 text-center text-gray-500 text-sm">
        <p>ğŸ’• 520æˆ¿é—´ - ç”¨çœŸå¿ƒæ¢å–çœŸçˆ± ğŸ’•</p>
    </footer>

    <!-- æ¨¡æ€æ¡† -->
    <!-- æ–°å¢é¢˜ç›®æ¨¡æ€æ¡† -->
    <div id="addQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-cute font-bold text-gray-800">æ–°å¢é¢˜ç›®</h3>
            </div>
            
            <form id="addQuestionForm">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">é¢˜ç›®å†…å®¹</label>
                    <textarea id="questionText" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" rows="3" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹..."></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">é€‰é¡¹A</label>
                        <input type="text" id="optionA" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" placeholder="é€‰é¡¹A">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">é€‰é¡¹B</label>
                        <input type="text" id="optionB" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" placeholder="é€‰é¡¹B">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">é€‰é¡¹C</label>
                        <input type="text" id="optionC" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" placeholder="é€‰é¡¹C">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">é€‰é¡¹D</label>
                        <input type="text" id="optionD" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" placeholder="é€‰é¡¹D">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">æ­£ç¡®ç­”æ¡ˆ</label>
                    <select id="correctAnswer" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent">
                        <option value="">è¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆ</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                
                <div class="flex justify-center gap-4">
                    <button type="button" onclick="hideAddQuestionModal()" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-medium rounded-lg transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-love-400 to-heart-400 hover:from-love-500 hover:to-heart-500 text-white font-medium rounded-lg transition-all duration-300">
                        ä¿å­˜é¢˜ç›®
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- é¢˜ç›®ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="questionManagementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-cute font-bold text-gray-800">é¢˜ç›®ç®¡ç†</h3>
            </div>
            
            <div id="questionList" class="space-y-4 mb-6">
                <!-- é¢˜ç›®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="flex justify-center gap-4">
                <button type="button" onclick="hideQuestionManagementModal()" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-medium rounded-lg transition-colors">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®è€ƒè¯•æ¨¡æ€æ¡† -->
    <div id="examSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-cute font-bold text-gray-800">è®¾ç½®è€ƒè¯•</h3>
            </div>
            
            <form id="examSettingsForm">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">æ¯åœºè€ƒè¯•é¢˜ç›®æ•°é‡</label>
                    <input type="number" id="questionCount" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" min="1" max="20" value="5">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">è·å¾—"å‰å¾€1122å§å®¤"æƒé™éœ€è¦ç­”å¯¹é¢˜ç›®æ•°</label>
                    <input type="number" id="bedroomPermissionScore" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" min="1" max="20" value="4">
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">è·å¾—"å®¢æ ˆä¸»äºº"æƒé™éœ€è¦ç­”å¯¹é¢˜ç›®æ•°</label>
                    <input type="number" id="adminPermissionScore" class="w-full p-3 border border-love-200 rounded-lg focus:ring-2 focus:ring-love-400 focus:border-transparent" min="1" max="20" value="5">
                </div>
                
                <div class="flex justify-center gap-4">
                    <button type="button" onclick="hideExamSettingsModal()" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-medium rounded-lg transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="px-6 py-3 bg-gradient-to-r from-love-400 to-heart-400 hover:from-love-500 hover:to-heart-500 text-white font-medium rounded-lg transition-all duration-300">
                        ä¿å­˜è®¾ç½®
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¼•å…¥ç™»å½•æ¨¡å— -->
    <script src="auth-modal.js"></script>

    <script>
        let currentUser = null;
        let currentExam = null;
        let examAnswers = [];
        let currentQuestionIndex = 0;

        // åˆå§‹åŒ–é¡µé¢
        window.addEventListener('load', () => {
            checkUserLogin();
        });

        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkUserLogin() {
            const userStr = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (userStr && token) {
                currentUser = JSON.parse(userStr);
                updateUserUI();
                checkUserPermissions();
            } else {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•
                alert('è¯·å…ˆç™»å½•åå†è¿›å…¥520æˆ¿é—´');
                window.location.href = 'index.html';
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userNickname').textContent = currentUser.nickname;
                document.getElementById('userAvatar').src = currentUser.avatar;
            }
        }

        // æ£€æŸ¥ç”¨æˆ·æƒé™
        async function checkUserPermissions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`https://fish-rabbit.site/api/exam/users/${currentUser.id}/permissions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.permissions && data.permissions.includes('å®¢æ ˆä¸»äºº')) {
                        // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
                        document.getElementById('adminPanel').classList.remove('hidden');
                    } else {
                        // æ˜¾ç¤ºæ™®é€šç”¨æˆ·é¢æ¿
                        document.getElementById('userPanel').classList.remove('hidden');
                    }
                } else {
                    // æ˜¾ç¤ºæ™®é€šç”¨æˆ·é¢æ¿
                    document.getElementById('userPanel').classList.remove('hidden');
                }
            } catch (error) {
                console.error('æ£€æŸ¥æƒé™å¤±è´¥:', error);
                // æ˜¾ç¤ºæ™®é€šç”¨æˆ·é¢æ¿
                document.getElementById('userPanel').classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºæ–°å¢é¢˜ç›®æ¨¡æ€æ¡†
        function showAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.remove('hidden');
            document.getElementById('addQuestionModal').classList.add('flex');
        }

        // éšè—æ–°å¢é¢˜ç›®æ¨¡æ€æ¡†
        function hideAddQuestionModal() {
            document.getElementById('addQuestionModal').classList.add('hidden');
            document.getElementById('addQuestionModal').classList.remove('flex');
            document.getElementById('addQuestionForm').reset();
        }

        // æ˜¾ç¤ºè®¾ç½®è€ƒè¯•æ¨¡æ€æ¡†
        function showExamSettingsModal() {
            document.getElementById('examSettingsModal').classList.remove('hidden');
            document.getElementById('examSettingsModal').classList.add('flex');
        }

        // éšè—è®¾ç½®è€ƒè¯•æ¨¡æ€æ¡†
        function hideExamSettingsModal() {
            document.getElementById('examSettingsModal').classList.add('hidden');
            document.getElementById('examSettingsModal').classList.remove('flex');
        }

        // æ˜¾ç¤ºé¢˜ç›®ç®¡ç†æ¨¡æ€æ¡†
        function showQuestionManagementModal() {
            document.getElementById('questionManagementModal').classList.remove('hidden');
            document.getElementById('questionManagementModal').classList.add('flex');
            loadQuestions();
        }

        // éšè—é¢˜ç›®ç®¡ç†æ¨¡æ€æ¡†
        function hideQuestionManagementModal() {
            document.getElementById('questionManagementModal').classList.add('hidden');
            document.getElementById('questionManagementModal').classList.remove('flex');
        }

        // åŠ è½½é¢˜ç›®åˆ—è¡¨
        async function loadQuestions() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('https://fish-rabbit.site/api/exam/questions', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayQuestions(data.questions);
                } else {
                    const error = await response.json();
                    alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                alert('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
        function displayQuestions(questions) {
            const container = document.getElementById('questionList');
            
            if (questions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— é¢˜ç›®</div>';
                return;
            }
            
            let html = '';
            questions.forEach((question, index) => {
                html += `
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-bold text-gray-800">é¢˜ç›® ${index + 1}</h4>
                            <button onclick="deleteQuestion(${question.id})" class="text-red-500 hover:text-red-700 text-sm px-3 py-1 rounded border border-red-300 hover:bg-red-50 transition-colors">
                                <i class="fas fa-trash mr-1"></i>åˆ é™¤
                            </button>
                        </div>
                        <div class="text-gray-700 mb-3">${question.question}</div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex items-center">
                                <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">A</span>
                                <span class="text-gray-600">${question.option_a}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">B</span>
                                <span class="text-gray-600">${question.option_b}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">C</span>
                                <span class="text-gray-600">${question.option_c}</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">D</span>
                                <span class="text-gray-600">${question.option_d}</span>
                            </div>
                        </div>
                        <div class="mt-3 text-sm">
                            <span class="text-gray-500">æ­£ç¡®ç­”æ¡ˆï¼š</span>
                            <span class="font-bold text-green-600">${question.correct_answer}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // åˆ é™¤é¢˜ç›®
        async function deleteQuestion(questionId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`https://fish-rabbit.site/api/exam/questions/${questionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('é¢˜ç›®åˆ é™¤æˆåŠŸï¼');
                    loadQuestions(); // é‡æ–°åŠ è½½é¢˜ç›®åˆ—è¡¨
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤é¢˜ç›®å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                console.error('åˆ é™¤é¢˜ç›®å¤±è´¥:', error);
                alert('åˆ é™¤é¢˜ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // å¼€å§‹è€ƒè¯•
        async function startExam() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('https://fish-rabbit.site/api/exam/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentExam = data.exam;
                    examAnswers = [];
                    currentQuestionIndex = 0;
                    
                    // æ˜¾ç¤ºè€ƒè¯•åŒºåŸŸ
                    document.getElementById('mainContent').classList.add('hidden');
                    document.getElementById('examArea').classList.remove('hidden');
                    
                    showQuestion();
                } else {
                    const error = await response.json();
                    alert('å¼€å§‹è€ƒè¯•å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                console.error('å¼€å§‹è€ƒè¯•å¤±è´¥:', error);
                alert('å¼€å§‹è€ƒè¯•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            const question = currentExam.questions[currentQuestionIndex];
            const progress = `ç¬¬ ${currentQuestionIndex + 1} é¢˜ / å…± ${currentExam.questions.length} é¢˜`;
            
            document.getElementById('examProgress').textContent = progress;
            
            const container = document.getElementById('questionContainer');
            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">${question.question}</h3>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 border border-love-200 rounded-lg hover:bg-love-50 cursor-pointer">
                            <input type="radio" name="answer" value="A" class="mr-3 text-love-400">
                            <span>A. ${question.optionA}</span>
                        </label>
                        <label class="flex items-center p-3 border border-love-200 rounded-lg hover:bg-love-50 cursor-pointer">
                            <input type="radio" name="answer" value="B" class="mr-3 text-love-400">
                            <span>B. ${question.optionB}</span>
                        </label>
                        <label class="flex items-center p-3 border border-love-200 rounded-lg hover:bg-love-50 cursor-pointer">
                            <input type="radio" name="answer" value="C" class="mr-3 text-love-400">
                            <span>C. ${question.optionC}</span>
                        </label>
                        <label class="flex items-center p-3 border border-love-200 rounded-lg hover:bg-love-50 cursor-pointer">
                            <input type="radio" name="answer" value="D" class="mr-3 text-love-400">
                            <span>D. ${question.optionD}</span>
                        </label>
                    </div>
                </div>
            `;
            
            // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®æˆ–æäº¤æŒ‰é’®
            if (currentQuestionIndex < currentExam.questions.length - 1) {
                document.getElementById('submitBtn').classList.add('hidden');
                if (!document.getElementById('nextBtn')) {
                    const nextBtn = document.createElement('button');
                    nextBtn.id = 'nextBtn';
                    nextBtn.className = 'inline-flex items-center gap-2 bg-gradient-to-r from-love-400 to-heart-400 hover:from-love-500 hover:to-heart-500 text-white font-bold py-3 px-6 rounded-full transition-all duration-300 shadow-lg hover:shadow-xl';
                    nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i><span>ä¸‹ä¸€é¢˜</span>';
                    nextBtn.onclick = nextQuestion;
                    document.querySelector('#examArea .flex.justify-center.gap-4.mt-8').appendChild(nextBtn);
                }
            } else {
                document.getElementById('submitBtn').classList.remove('hidden');
                const nextBtn = document.getElementById('nextBtn');
                if (nextBtn) nextBtn.remove();
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            const selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (!selectedAnswer) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                return;
            }
            
            examAnswers.push({
                questionId: currentExam.questions[currentQuestionIndex].id,
                answer: selectedAnswer.value
            });
            
            currentQuestionIndex++;
            showQuestion();
        }

        // æäº¤è€ƒè¯•
        async function submitExam() {
            const selectedAnswer = document.querySelector('input[name="answer"]:checked');
            if (!selectedAnswer) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç­”æ¡ˆ');
                return;
            }
            
            examAnswers.push({
                questionId: currentExam.questions[currentQuestionIndex].id,
                answer: selectedAnswer.value
            });
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('https://fish-rabbit.site/api/exam/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        examId: currentExam.id,
                        answers: examAnswers
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showExamResult(data);
                } else {
                    const error = await response.json();
                    alert('æäº¤è€ƒè¯•å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                console.error('æäº¤è€ƒè¯•å¤±è´¥:', error);
                alert('æäº¤è€ƒè¯•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ˜¾ç¤ºè€ƒè¯•ç»“æœ
        function showExamResult(result) {
            document.getElementById('examArea').classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            
            const container = document.getElementById('resultContent');
            let html = `
                <div class="mb-6">
                    <div class="text-3xl font-bold text-love-400 mb-2">${result.score} / ${result.totalQuestions}</div>
                    <div class="text-gray-600 mb-4">æ­£ç¡®ç‡ï¼š${Math.round(result.score / result.totalQuestions * 100)}%</div>
            `;
            
            if (result.newPermissions && result.newPermissions.length > 0) {
                html += `
                    <div class="bg-gradient-to-r from-love-100 to-heart-100 rounded-lg p-4 mb-4">
                        <div class="text-lg font-bold text-love-600 mb-2">ğŸ‰ æ­å–œè·å¾—æ–°æƒé™ï¼</div>
                        <div class="text-love-500">${result.newPermissions.join('ã€')}</div>
                    </div>
                `;
            }
            
            html += `
                <div class="text-left">
                    <h4 class="font-bold text-gray-800 mb-3">è¯¦ç»†ç»“æœï¼š</h4>
                    <div class="space-y-3">
            `;
            
            result.details.forEach((detail, index) => {
                const isCorrect = detail.isCorrect;
                const bgColor = isCorrect ? 'bg-green-50' : 'bg-red-50';
                const textColor = isCorrect ? 'text-green-600' : 'text-red-600';
                const icon = isCorrect ? 'fas fa-check-circle' : 'fas fa-times-circle';
                
                html += `
                    <div class="${bgColor} p-3 rounded-lg">
                        <div class="flex items-center mb-2">
                            <i class="${icon} ${textColor} mr-2"></i>
                            <span class="font-medium">ç¬¬ ${index + 1} é¢˜</span>
                        </div>
                        <div class="text-sm text-gray-700 mb-1">${detail.question}</div>
                        <div class="text-sm">
                            <span class="text-gray-600">ä½ çš„ç­”æ¡ˆï¼š</span>
                            <span class="${textColor}">${detail.userAnswer}</span>
                        </div>
                        ${!isCorrect ? `
                            <div class="text-sm">
                                <span class="text-gray-600">æ­£ç¡®ç­”æ¡ˆï¼š</span>
                                <span class="text-green-600">${detail.correctAnswer}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // å–æ¶ˆè€ƒè¯•
        function cancelExam() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆè€ƒè¯•å—ï¼Ÿ')) {
                goBackToMain();
            }
        }

        // è¿”å›ä¸»é¡µ
        function goBackToMain() {
            document.getElementById('examArea').classList.add('hidden');
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            currentExam = null;
            examAnswers = [];
            currentQuestionIndex = 0;
        }

        // è¿”å›å¤§å ‚
        function goBack() {
            window.location.href = 'index.html';
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                question: document.getElementById('questionText').value,
                optionA: document.getElementById('optionA').value,
                optionB: document.getElementById('optionB').value,
                optionC: document.getElementById('optionC').value,
                optionD: document.getElementById('optionD').value,
                correctAnswer: document.getElementById('correctAnswer').value
            };
            
            if (!formData.question || !formData.optionA || !formData.optionB || !formData.optionC || !formData.optionD || !formData.correctAnswer) {
                alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('https://fish-rabbit.site/api/exam/questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('é¢˜ç›®æ·»åŠ æˆåŠŸï¼');
                    hideAddQuestionModal();
                } else {
                    const error = await response.json();
                    alert('æ·»åŠ é¢˜ç›®å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                console.error('æ·»åŠ é¢˜ç›®å¤±è´¥:', error);
                alert('æ·»åŠ é¢˜ç›®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });

        document.getElementById('examSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                questionCount: parseInt(document.getElementById('questionCount').value),
                bedroomPermissionScore: parseInt(document.getElementById('bedroomPermissionScore').value),
                adminPermissionScore: parseInt(document.getElementById('adminPermissionScore').value)
            };
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('https://fish-rabbit.site/api/exam/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('è€ƒè¯•è®¾ç½®ä¿å­˜æˆåŠŸï¼');
                    hideExamSettingsModal();
                } else {
                    const error = await response.json();
                    alert('ä¿å­˜è®¾ç½®å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        });
    </script>
</body>
</html>
